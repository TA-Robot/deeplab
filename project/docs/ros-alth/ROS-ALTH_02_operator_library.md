# ROS/ALTH 検討メモ 02: 演算子ライブラリ（微分可能・増殖可能な写像設計）

作成日: 2025-12-29  
目的: 「微分可能性」を守りつつ、演算子 \(f_k\) を **どんどん増やして**も壊れない設計にする。

---

## 0. 方針（必須制約）

- 全演算子 \(f_k\) は **微分可能**（もしくは滑らかな近似を採用）
- 離散的な選択（top-k/argmax でのルーティング）はしない
- 演算子の出力は混合前に **Norm**（LayerNorm/RMSNorm等）
- 演算子は “種類を増やす” だけでなく、**スケール・温度・周波数**などの連続パラメータの分布を広げて多様性を作る

---

## 1. 演算子の6系統（増やす地図）

ここでは、演算子 \(f_k\) を以下の系統に分類して増やす。  
各系統の中で「連続パラメータ（温度、スケール、周波数、拡散係数…）」を乱数で散らす。

### 系統1: 周波数・スペクトル系（RFF/周期）
目的: 低〜高周波の多様な基底を注入する。

- Random Fourier Features:
  - \(z = hW + b\)
  - \(f(h)=\sin(z)\) / \(\cos(z)\)
- 周波数スケールの乱数:
  - \(W\) の分散をスケール \(s\) で調整（\(s\) を対数一様に散らす等）

**増殖パラメータ例**
- \(s\in[10^{-2}, 10^{2}]\)（対数スケールで散らす）
- \(\tau\)（温度）で滑らかさを変える場合は \(\tau\in[0.1, 5]\)

---

### 系統2: 多項式・有理関数・ゲート（高次相互作用）
目的: ReLU等の単純非線形だけでなく、高次の相互作用を初期から含む。

- 多項式:
  - \(f(h)=h\), \(h^2\), \(h^3\)（要 Norm）
- ゲート:
  - \(f(h)=u\odot\sigma(v)\)（\(u,v\) は共有線形変換の出力を分岐して作ると安い）
- 有理関数（安定化必須）:
  - \(f(h)=\frac{p(h)}{q(h)+\epsilon}\), \(\epsilon>0\)

**増殖パラメータ例**
- 次数（2,3,4…）を増やす
- \(\epsilon\) を固定（例 1e-3）し数値安定を担保

---

### 系統3: 拡散・PDE・幾何（連続“手続き”）
目的: 「アルゴリズムっぽい連続変換」を注入する。

- 拡散ステップ（離散ラプラシアン相当）:
  - \(f(h)=h + \alpha\,\Delta h\)
- 勾配/エッジ系フィルタ（画像なら conv として実装）
- 平滑化（ガウシアン）:
  - \(f(h)=G_\sigma * h\)（\(\sigma\) を散らす）

**増殖パラメータ例**
- \(\alpha\in[10^{-3}, 10^{-1}]\)（対数一様）
- \(\sigma\in[0.5, 4.0]\)

---

### 系統4: カーネル・近傍集約・注意（soft な比較）
目的: 比較・近傍・重み付き集約の表現を持つ。

- プロトタイプ/RBF:
  - \(\phi_j(h)=\exp(-\|h-c_j\|^2/\sigma^2)\)
- ソフト近傍集約:
  - 距離 \(d(h_i,h_j)\) から \(\mathrm{softmax}(-d/\tau)\) を作り加重平均

**増殖パラメータ例**
- プロトタイプ数 \(J\) を増やす（共有計算で距離行列は再利用）
- \(\sigma,\tau\) を散らす

---

### 系統5: ソート・ランキング・置換の連続緩和（微分可能化された手続き）
目的: “順位・割当”のような手続き的変換を微分可能に組み込む。

- SoftSort / NeuralSort などの連続緩和（温度 \(\tau\) を持つ）
- Sinkhorn による置換の連続緩和（正則化・反復回数をパラメータ化）

**増殖パラメータ例**
- \(\tau\)（滑らかさ）を多点で用意
- Sinkhorn の反復回数 \(T\) を {3,5,10} 等で増やす  
  ※反復は重くなるので “高Tは少数” から

---

### 系統6: max/min 由来の操作の滑らか近似（形態学・分位）
目的: 強い非線形（max/min）を微分可能に近似して増やす。

- log-sum-exp pooling:
  - \(\mathrm{LSE}_\tau(x)=\tau\log\sum_i\exp(x_i/\tau)\)
- softmin: \(-\mathrm{LSE}_\tau(-x)\)

**増殖パラメータ例**
- \(\tau\) を小〜大で多数用意（maxっぽい〜平均っぽい連続体）

---

## 2. 演算子を“ランダムプログラム”として生成する（微分可能プリミティブ合成）

### 2.1 記号
- プリミティブ集合: \(\mathcal{P}\)（全て微分可能）
- プログラム深さ: \(m\)
- 演算子: \(f_k = p_{k,m}\circ\cdots\circ p_{k,1}\), \(p_{k,i}\in\mathcal{P}\)

### 2.2 プリミティブ例（推奨）
- 共有線形: \(hW\)
- 非線形: sin/cos, GELU, tanh, sigmoid, polynomial, rational
- 正規化: LayerNorm/RMSNorm
- Soft 手続き: SoftSort, Sinkhorn, soft-pool
- 平滑化: Gaussian blur, diffusion step
- 距離→softmax 集約: soft-neighbor aggregation

### 2.3 生成ルール（例）
- m を {2,3,4} からサンプル
- 途中に residual 分岐を確率 \(p_{skip}\) で入れる
- 各プリミティブの連続パラメータ（\(\tau,\sigma,\alpha,s\)）を対数一様などで散らす
- 最後に必ず \(\mathrm{Norm}\)（もしくは混合前に Norm）

これにより “演算子数 K を増やす = ランダムな微分可能手続きを増やす” が実装できる。

---

## 3. 共有計算の設計（増やしても重くしない）

演算子を増やすときは、次の共有を最優先にする。

- **共有線形出力** \(z=hW\) を分岐して多数の非線形へ
- 距離行列 \(D\) を1回作り、温度違いの soft-neighbor を複数生成
- 畳み込み出力を1回計算し、複数の \(\tau\) の soft-pool / 平滑化へ分岐

---

## 4. 実装テンプレ（演算子のインタフェース）

- 入力: \(h\in\mathbb{R}^{B\times d}\)
- 出力: \(\mathbb{R}^{B\times d}\)（形は揃える）
- 内部乱数: \(\omega_k\)（固定推奨）
- 連続パラメータ: \(\tau,\sigma,\alpha,s\)（固定 or 一部学習）

---

## 5. 最初の “ミニライブラリ” 例（K=32）

- 周波数: sin/cos（スケール 8種×2 = 16）
- 多項式: \(h^2,h^3\)（2）
- ゲート: \(u\odot\sigma(v)\)（2）
- 拡散: \(\alpha\) 4種（4）
- soft-pool (LSE): \(\tau\) 4種（4）
- soft-neighbor: \(\tau\) 4種（4）

合計 32。ここから倍々に増やす（スケール点を増やす、系統5を少数追加、など）。

